<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest ì •ë¦¬ì‹¤ ì‘ì—… ë“±ë¡</title>
    <style>
        body { font-family: 'Inter', sans-serif; padding: 20px; background-color: #f4f7f9; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); }
        h1 { color: #1e3a8a; text-align: center; margin-bottom: 30px; }
        h2 { color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; margin-top: 30px; }
        
        /* Table Styling */
        .data-table, .input-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .data-table th, .data-table td, .input-table th, .input-table td { border: 1px solid #e5e7eb; padding: 10px; text-align: center; }
        .data-table th, .input-table th { background-color: #eff6ff; color: #1e3a8a; font-weight: 600; }
        .data-table tr:nth-child(even) { background-color: #f9fafb; }

        /* Form/Input Styling */
        /* ì…ë ¥ì°½ ë„ˆë¹„ 100%ë¡œ ë³€ê²½ */
        .input-table input[type="text"], .input-table input[type="date"], .input-table select { 
            width: 100%; 
            padding: 6px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        /* êµ¬ë¶„(ì²« ë²ˆì§¸) ì—´ ë„ˆë¹„ í™•ì¥ */
        .input-table th:nth-child(1), .input-table td:nth-child(1) {
            width: 10%; 
        }
        .input-table td.center-content { padding: 0; }
        
        /* Button Styling */
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .action-buttons button, #insertButton, #homeButton { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.3s; }
        #insertButton { background-color: #10b981; color: white; width: 100%; margin-top: 15px; }
        #insertButton:hover { background-color: #059669; }
        #homeButton { background-color: #6b7280; color: white; width: 100px; margin-top: 20px;}
        #homeButton:hover { background-color: #4b5563; }
        .edit-buttons button { background-color: #f97316; color: white; }
        .edit-buttons button:hover { background-color: #ea580c; }
        .delete-buttons button { background-color: #ef4444; color: white; }
        .delete-buttons button:hover { background-color: #dc2626; }
        .complete-buttons button { background-color: #2563eb; color: white; }

        /* Pagination */
        .pagination { margin-top: 15px; text-align: center; }
        .pagination button { margin: 0 5px; padding: 8px 12px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; }
        .pagination button.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }

        /* Messages */
        #messageBox { padding: 10px; margin-top: 15px; border-radius: 6px; text-align: center; display: none; }
        .success { background-color: #d1fae5; color: #065f46; }
        .error { background-color: #fee2e2; color: #991b1b; }

        /* catalog_admin.html íŒŒì¼ì˜ <style> íƒœê·¸ ë‚´ì— ì¶”ê°€ */
        .data-table td[data-col="worker"] {
        /* ë„ˆë¹„ ì œí•œ: í…Œì´ë¸” ì „ì²´ ë„ˆë¹„ì— ë§ì¶° ì ì ˆí•œ ê°’ ì„¤ì • */
        max-width: 60px; /* ì˜ˆì‹œ: 120pxë¡œ ì œí•œ */
        
        /* í…ìŠ¤íŠ¸ê°€ ë„˜ì¹  ë•Œ ìˆ¨ê¹€ */
        overflow: hidden;
        
        /* í…ìŠ¤íŠ¸ë¥¼ í•œ ì¤„ë¡œ ìœ ì§€ */
        white-space: nowrap;
        
        /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ë¥¼ ì¤„ì„í‘œ(...)ë¡œ í‘œì‹œ */
        text-overflow: ellipsis;
        }      
    </style>
</head>
<body>
    <div class="container">
        <h1 id="pageTitle">Guest ì •ë¦¬ì‹¤ ì‘ì—… ë“±ë¡</h1>
        <button id="homeButton">HOME</button>
        <div id="messageBox"></div>

        <h2>ì‹ ê·œ ë“±ë¡</h2>
        <table class="input-table">
            <thead>
                <tr>
                    <th>êµ¬ë¶„</th> <th>ì‘ì—…ì</th>
                    <th>ì‘ì—…ì¼ì‹œ</th>
                    <th>ì‹ ê·œ ì¢…ìˆ˜</th>
                    <th>ì‹ ê·œ ì±…ìˆ˜</th>
                    <th>ì¬ì •ë¦¬ ì¢…ìˆ˜</th>
                    <th>ì¬ì •ë¦¬ ì±…ìˆ˜</th>
                    <th>ë‹¤ê¶Œë³¸ ì¢…ìˆ˜</th>
                    <th>ë‹¤ê¶Œë³¸ ì±…ìˆ˜</th>
                    <th>êµì—´ ì±…ìˆ˜</th>
                    <th>ì „ê±° ìˆ˜</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><select id="input_region"><option value="êµ­ë‚´">êµ­ë‚´</option><option value="êµ­ì™¸">êµ­ì™¸</option></select></td>
                    <td><input type="text" id="input_worker" value=""></td>
                    <td><input type="date" id="input_w_date"></td>
                    <td><input type="text" id="input_new_species" value="0"></td>
                    <td><input type="text" id="input_new_bookcount" value="0"></td>
                    <td><input type="text" id="input_rearray_species" value="0"></td>
                    <td><input type="text" id="input_rearray_bookcount" value="0"></td>
                    <td><input type="text" id="input_multipart_species" value="0"></td>
                    <td><input type="text" id="input_multipart_bookcount" value="0"></td>
                    <td><input type="text" id="input_edit_bookcount" value="0"></td>
                    <td><input type="text" id="input_authority_bookcount" value="0"></td>
                </tr>
            </tbody>
        </table>
        <button id="insertButton">ë“±ë¡</button>


        <h2 style="margin-top: 50px;">ì‘ì—… ë‚´ìš© ì¡°íšŒ ë° ìˆ˜ì •/ì‚­ì œ (ìµœê·¼ 3ì¼)</h2>
        <div class="action-buttons">
            <button id="editStartButton" class="edit-buttons" disabled>ìˆ˜ì •</button>
            <button id="deleteButton" class="delete-buttons" disabled>ì‚­ì œ</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ì„ íƒ</th>
                    <th>ID</th>
                    <th>ì§€ì—­</th>
                    <th>ì‘ì—…ì</th>
                    <th>ì‘ì—…ì¼ì‹œ</th>
                    <th>ì‹ ê·œ ì¢…ìˆ˜</th>
                    <th>ì‹ ê·œ ì±…ìˆ˜</th>
                    <th>ì¬ì •ë¦¬ ì¢…ìˆ˜</th>
                    <th>ì¬ì •ë¦¬ ì±…ìˆ˜</th>
                    <th>ë‹¤ê¶Œë³¸ ì¢…ìˆ˜</th>
                    <th>ë‹¤ê¶Œë³¸ ì±…ìˆ˜</th>
                    <th>êµì—´ ì±…ìˆ˜</th>
                    <th>ì „ê±° ìˆ˜</th>
                    <th>ìˆ˜ì • ê³„ì •</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                </tbody>
        </table>
        <div id="paginationContainer" class="pagination"></div>
    </div>

    <script>
        const BASE_URL = 'https://port-0-loyola-cataloging-pjt-mgmc05ze5b2b3168.sel3.cloudtype.app/api/catalog';
        const urlParams = new URLSearchParams(window.location.search);
        const USER_ACCOUNT = urlParams.get('user') || 'guest';
        
        let currentPage = 1;
        const itemsPerPage = 10;
        let isEditing = false;
        let selectedId = null;

        document.getElementById('pageTitle').textContent = USER_ACCOUNT.toUpperCase() + ' ì •ë¦¬ì‹¤ ì‘ì—… ë“±ë¡';

        // Helper to display messages
        function showMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'messageBox ' + type;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 5000);
        }

        // Get today's date in YYYY-MM-DD format (for input default)
        function getTodayDate() {
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        document.getElementById('input_w_date').value = getTodayDate();

        // ğŸŒŸ ìš”ì²­í•˜ì‹  ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€: ì‘ì—…ì í•„ë“œì— ëœë¤ ê°’ ì„¤ì • ğŸŒŸ
        function setRandomWorker() {
            const workerNames = ['ë¡œìšœë¼', 'ë„ì„œê´€', 'ì„œê°•ëŒ€', 'ì •ë¦¬ì‹¤', 'ì¸ë²¤íŠ¬', 'ì—´ëŒì‹¤', 'ING', 'ëŒ€ì¶œëŒ€' ,'ë¬´ì¸ë°˜ë‚©', 'ìœ ë“œë¦¼í™€', 'ìº í¼ìŠ¤' ,'ë°•ì°¬ìš±', 'ë¬¸ì„±ê·¼', 'ë°•ì€ë¹ˆ', 'ë§ˆì™•', 'ì–‘í¬ì€', 'ìœ ë³‘ì¬','ì˜ˆìˆ˜íšŒ','ì´ëƒì‹œì˜¤','ì§„ë¦¬','ìˆœì¢…',' IHS','ì„œê°•ì²´','ì•Œë°”íŠ¸ë¡œìŠ¤','ì´í¬ìŠ¹','ì•ˆìµíƒœ','ì„œê°•ì´','ì•Œë¡œìŠ¤','ê²Œí˜ë¥´íŠ¸','ê°€ë¸Œë¦¬ì—˜','ë§ˆíƒœì˜¤ê´€','ëª¨ì–´','ë©”ë¦¬í™€','ì— ë§ˆì˜¤','ìµœì–‘ì—…','í•˜ë¹„ì—ë¥´','ë‹¤ì‚°','ê³¤ìê°€','ì•„ë‹´ìƒ¬','ê¹€ëŒ€ê±´','ì•„ë£¨í˜','ë² ë¥´í¬ë§ŒìŠ¤','ë…¸ê³ ì‚°','í•˜ëŠ¬ê°€ëŒ','ë°±ë²”ë¡œ' ];
            // 0, 1, 2 ì¤‘ í•˜ë‚˜ì˜ ëœë¤ ì¸ë±ìŠ¤ë¥¼ ìƒì„±
            const randomIndex = Math.floor(Math.random() * workerNames.length); 
            const randomName = workerNames[randomIndex];
            
            const workerInput = document.getElementById('input_worker');
            if (workerInput) {
                workerInput.value = randomName;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‘ì—…ì ì´ë¦„ ëœë¤ìœ¼ë¡œ ì„¤ì •
        setRandomWorker();
        // ğŸŒŸ ìš”ì²­í•˜ì‹  ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ ë ğŸŒŸ

        // 8) & 12) HOME ë²„íŠ¼ ì´ë™
        document.getElementById('homeButton').addEventListener('click', () => {
            window.location.href = 'index.html';
        });


        // --- Data Fetching and Table Rendering ---

        async function fetchData(page = 1) {
            currentPage = page;
            try {
                const response = await fetch(`${BASE_URL}?page=${currentPage}&limit=${itemsPerPage}&period=3ì¼ì „`);
                if (!response.ok) throw new Error('ë°ì´í„° ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                
                const result = await response.json();
                renderTable(result.data);
                renderPagination(result.pagination.totalPages);

            } catch (error) {
                console.error('Fetch error:', error);
                showMessage('ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            selectedId = null;
            document.getElementById('editStartButton').disabled = true;
            document.getElementById('deleteButton').disabled = true;
            isEditing = false;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.id = item.id;
                
                tr.innerHTML = `
                    <td><input type="radio" name="selectRow" value="${item.id}" onchange="handleRowSelection(this)"></td>
                    <td>${item.id}</td>
                    <td data-col="region">${item.region}</td>
                    <td data-col="worker" title="${item.worker}">${item.worker}</td>
                    <td data-col="w_date">${item.w_date.substring(0, 10)}</td>
                    <td data-col="new_species">${item.new_species}</td>
                    <td data-col="new_bookcount">${item.new_bookcount}</td>
                    <td data-col="rearray_species">${item.rearray_species}</td>
                    <td data-col="rearray_bookcount">${item.rearray_bookcount}</td>
                    <td data-col="multipart_species">${item.multipart_species}</td>
                    <td data-col="multipart_bookcount">${item.multipart_bookcount}</td>
                    <td data-col="edit_bookcount">${item.edit_bookcount}</td>
                    <td data-col="authority_bookcount">${item.authority_bookcount}</td>
                    <td data-col="update_user">${item.update_user}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination(totalPages) {
            const container = document.getElementById('paginationContainer');
            container.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.add('page-button');
                if (i === currentPage) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => fetchData(i));
                container.appendChild(button);
            }
        }

        function handleRowSelection(radio) {
            selectedId = radio.value;
            document.getElementById('editStartButton').disabled = false;
            document.getElementById('deleteButton').disabled = false;
        }

        // --- CRUD Operations ---

        // 6-4) ì‹ ê·œ ë“±ë¡
        document.getElementById('insertButton').addEventListener('click', async () => {
            const data = {
                region: document.getElementById('input_region').value,
                worker: document.getElementById('input_worker').value,
                w_date: document.getElementById('input_w_date').value,
                new_species: document.getElementById('input_new_species').value,
                new_bookcount: document.getElementById('input_new_bookcount').value,
                rearray_species: document.getElementById('input_rearray_species').value,
                rearray_bookcount: document.getElementById('input_rearray_bookcount').value,
                multipart_species: document.getElementById('input_multipart_species').value,
                multipart_bookcount: document.getElementById('input_multipart_bookcount').value,
                edit_bookcount: document.getElementById('input_edit_bookcount').value,
                authority_bookcount: document.getElementById('input_authority_bookcount').value,
                update_user: USER_ACCOUNT // 6-2) loginê³„ì • ì‚¬ìš©
            };

            try {
                const response = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('ë“±ë¡ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');

                const result = await response.json();
                showMessage('ì‹ ê·œ ì¹´íƒˆë¡œê¹… ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: ' + result.data.id + ')');
                fetchData(1); // 6-4) í‘œ refresh
            } catch (error) {
                console.error('Insert error:', error);
                showMessage('ë“±ë¡ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        });

        // 7-2) ì‚­ì œ ì‘ì—…
        document.getElementById('deleteButton').addEventListener('click', async () => {
            if (!selectedId) {
                showMessage('ì‚­ì œí•  í•­ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm('ì •ë§ë¡œ ID ' + selectedId + ' í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/${selectedId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('ì‚­ì œ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');

                showMessage('ID ' + selectedId + ' í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchData(currentPage); // í‘œ refresh
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('ì‚­ì œ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        });

        // 7-1) ìˆ˜ì • ì‘ì—… ì‹œì‘
        document.getElementById('editStartButton').addEventListener('click', (e) => {
            if (!selectedId) {
                showMessage('ìˆ˜ì •í•  í•­ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            if (isEditing) return; // ì´ë¯¸ ìˆ˜ì • ì¤‘ì´ë©´ ë¬´ì‹œ

            isEditing = true;
            e.target.textContent = 'ìˆ˜ì • ì™„ë£Œ';
            e.target.id = 'editCompleteButton';
            e.target.className = 'complete-buttons';
            document.getElementById('deleteButton').disabled = true;

            const row = document.querySelector(`tr[data-id="${selectedId}"]`);
            const colsToEdit = ['region', 'worker', 'w_date', 'new_species', 'new_bookcount', 'rearray_species', 'rearray_bookcount', 'multipart_species', 'multipart_bookcount', 'edit_bookcount', 'authority_bookcount'];
            
            colsToEdit.forEach(col => {
                const cell = row.querySelector(`td[data-col="${col}"]`);
                const originalValue = cell.textContent;
                
                let inputElement;
                if (col === 'region') {
                    inputElement = `<select id="edit_${col}"><option value="êµ­ë‚´">êµ­ë‚´</option><option value="êµ­ì™¸">êµ­ì™¸</option></select>`;
                } else if (col === 'w_date') {
                    inputElement = `<input type="date" id="edit_${col}" value="${originalValue.substring(0, 10)}" style="width: 100%;">`;
                } else {
                    inputElement = `<input type="text" id="edit_${col}" value="${originalValue}" style="width: 100%;">`;
                }
                
                cell.dataset.original = originalValue;
                cell.innerHTML = inputElement;
                if (col === 'region') {
                    document.getElementById(`edit_${col}`).value = originalValue;
                }
            });

            // Re-attach the event listener to the new 'ìˆ˜ì • ì™„ë£Œ' button
            document.getElementById('editCompleteButton').addEventListener('click', handleEditComplete, { once: true });
        });

        // 7-1) ìˆ˜ì • ì‘ì—… ì™„ë£Œ
        async function handleEditComplete() {
            const row = document.querySelector(`tr[data-id="${selectedId}"]`);
            const colsToEdit = ['region', 'worker', 'w_date', 'new_species', 'new_bookcount', 'rearray_species', 'rearray_bookcount', 'multipart_species', 'multipart_bookcount', 'edit_bookcount', 'authority_bookcount'];
            
            const updatedData = {
                id: selectedId,
                update_user: USER_ACCOUNT // 7-1) loginê³„ì • ì‚¬ìš©
            };

            // Collect updated data
            colsToEdit.forEach(col => {
                const inputElement = document.getElementById(`edit_${col}`);
                if (inputElement) {
                    updatedData[col] = inputElement.value;
                }
            });
            
            try {
                const response = await fetch(`${BASE_URL}/${selectedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                if (!response.ok) throw new Error('ìˆ˜ì • ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');

                showMessage('ID ' + selectedId + ' í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                fetchData(currentPage); // í‘œ refresh

            } catch (error) {
                console.error('Update error:', error);
                showMessage('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message, 'error');
                fetchData(currentPage); // ì˜¤ë¥˜ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
            } finally {
                // Restore button state
                const completeButton = document.getElementById('editCompleteButton');
                completeButton.textContent = 'ìˆ˜ì •';
                completeButton.id = 'editStartButton';
                completeButton.className = 'edit-buttons';
                document.getElementById('deleteButton').disabled = false;
                isEditing = false;
            }
        }

        // Initial Data Load (7. today - 3 day data)
        fetchData(1);
    </script>
</body>
</html>
