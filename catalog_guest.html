<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest 정리실 작업 등록</title>
    <style>
        body { font-family: 'Inter', sans-serif; padding: 20px; background-color: #f4f7f9; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); }
        h1 { color: #1e3a8a; text-align: center; margin-bottom: 30px; }
        h2 { color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 5px; margin-top: 30px; }
        
        /* Table Styling */
        .data-table, .input-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .data-table th, .data-table td, .input-table th, .input-table td { border: 1px solid #e5e7eb; padding: 10px; text-align: center; }
        .data-table th, .input-table th { background-color: #eff6ff; color: #1e3a8a; font-weight: 600; }
        .data-table tr:nth-child(even) { background-color: #f9fafb; }

        /* Form/Input Styling */
        /* 입력창 너비 100%로 변경 */
        .input-table input[type="text"], .input-table input[type="date"], .input-table select { 
            width: 100%; 
            padding: 6px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        /* 구분(첫 번째) 열 너비 확장 */
        .input-table th:nth-child(1), .input-table td:nth-child(1) {
            width: 10%; 
        }
        .input-table td.center-content { padding: 0; }
        
        /* Button Styling */
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .action-buttons button, #insertButton, #homeButton { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.3s; }
        #insertButton { background-color: #10b981; color: white; width: 100%; margin-top: 15px; }
        #insertButton:hover { background-color: #059669; }
        #homeButton { background-color: #6b7280; color: white; width: 100px; margin-top: 20px;}
        #homeButton:hover { background-color: #4b5563; }
        .edit-buttons button { background-color: #f97316; color: white; }
        .edit-buttons button:hover { background-color: #ea580c; }
        .delete-buttons button { background-color: #ef4444; color: white; }
        .delete-buttons button:hover { background-color: #dc2626; }
        .complete-buttons button { background-color: #2563eb; color: white; }

        /* Pagination */
        .pagination { margin-top: 15px; text-align: center; }
        .pagination button { margin: 0 5px; padding: 8px 12px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; }
        .pagination button.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }

        /* Messages */
        #messageBox { padding: 10px; margin-top: 15px; border-radius: 6px; text-align: center; display: none; }
        .success { background-color: #d1fae5; color: #065f46; }
        .error { background-color: #fee2e2; color: #991b1b; }

        /* catalog_admin.html 파일의 <style> 태그 내에 추가 */
        .data-table td[data-col="worker"] {
        /* 너비 제한: 테이블 전체 너비에 맞춰 적절한 값 설정 */
        max-width: 60px; /* 예시: 120px로 제한 */
        
        /* 텍스트가 넘칠 때 숨김 */
        overflow: hidden;
        
        /* 텍스트를 한 줄로 유지 */
        white-space: nowrap;
        
        /* 넘치는 텍스트를 줄임표(...)로 표시 */
        text-overflow: ellipsis;
        }      
    </style>
</head>
<body>
    <div class="container">
        <h1 id="pageTitle">Guest 정리실 작업 등록</h1>
        <button id="homeButton">HOME</button>
        <div id="messageBox"></div>

        <!-- 6) 화면 상단 - 신규 등록 -->
        <h2>신규 등록</h2>
        <table class="input-table">
            <thead>
                <tr>
                    <th>구분</th> <!-- '지역' -> '구분' 변경 -->
                    <th>작업자</th>
                    <th>작업일시</th>
                    <th>신규 종수</th>
                    <th>신규 책수</th>
                    <th>재정리 종수</th>
                    <th>재정리 책수</th>
                    <th>다권본 종수</th>
                    <th>다권본 책수</th>
                    <th>교열 책수</th>
                    <th>전거 수</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><select id="input_region"><option value="국내">국내</option><option value="국외">국외</option></select></td>
                    <td><input type="text" id="input_worker" value="로욜라"></td>
                    <td><input type="date" id="input_w_date"></td>
                    <td><input type="text" id="input_new_species" value="0"></td>
                    <td><input type="text" id="input_new_bookcount" value="0"></td>
                    <td><input type="text" id="input_rearray_species" value="0"></td>
                    <td><input type="text" id="input_rearray_bookcount" value="0"></td>
                    <td><input type="text" id="input_multipart_species" value="0"></td>
                    <td><input type="text" id="input_multipart_bookcount" value="0"></td>
                    <td><input type="text" id="input_edit_bookcount" value="0"></td>
                    <td><input type="text" id="input_authority_bookcount" value="0"></td>
                </tr>
            </tbody>
        </table>
        <button id="insertButton">등록</button>


        <!-- 7) 화면 하단 - 수정/삭제 데이터 -->
        <h2 style="margin-top: 50px;">작업 내용 조회 및 수정/삭제 (최근 3일)</h2>
        <div class="action-buttons">
            <button id="editStartButton" class="edit-buttons" disabled>수정</button>
            <button id="deleteButton" class="delete-buttons" disabled>삭제</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>선택</th>
                    <th>ID</th>
                    <th>지역</th>
                    <th>작업자</th>
                    <th>작업일시</th>
                    <th>신규 종수</th>
                    <th>신규 책수</th>
                    <th>재정리 종수</th>
                    <th>재정리 책수</th>
                    <th>다권본 종수</th>
                    <th>다권본 책수</th>
                    <th>교열 책수</th>
                    <th>전거 수</th>
                    <th>수정 계정</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                <!-- Data rows will be inserted here -->
            </tbody>
        </table>
        <div id="paginationContainer" class="pagination"></div>
    </div>

    <script>
        const BASE_URL = 'https://port-0-loyola-cataloging-pjt-mgmc05ze5b2b3168.sel3.cloudtype.app/api/catalog';
        const urlParams = new URLSearchParams(window.location.search);
        const USER_ACCOUNT = urlParams.get('user') || 'guest';
        
        let currentPage = 1;
        const itemsPerPage = 10;
        let isEditing = false;
        let selectedId = null;

        document.getElementById('pageTitle').textContent = USER_ACCOUNT.toUpperCase() + ' 정리실 작업 등록';

        // Helper to display messages
        function showMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'messageBox ' + type;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 5000);
        }

        // Get today's date in YYYY-MM-DD format (for input default)
        function getTodayDate() {
            const today = new Date();
            const y = today.getFullYear();
            const m = String(today.getMonth() + 1).padStart(2, '0');
            const d = String(today.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        document.getElementById('input_w_date').value = getTodayDate();

        // 8) & 12) HOME 버튼 이동
        document.getElementById('homeButton').addEventListener('click', () => {
            window.location.href = 'index.html';
        });


        // --- Data Fetching and Table Rendering ---

        async function fetchData(page = 1) {
            currentPage = page;
            try {
                const response = await fetch(`${BASE_URL}?page=${currentPage}&limit=${itemsPerPage}&period=3일전`);
                if (!response.ok) throw new Error('데이터 조회에 실패했습니다.');
                
                const result = await response.json();
                renderTable(result.data);
                renderPagination(result.pagination.totalPages);

            } catch (error) {
                console.error('Fetch error:', error);
                showMessage('데이터 조회 중 오류 발생: ' + error.message, 'error');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            selectedId = null;
            document.getElementById('editStartButton').disabled = true;
            document.getElementById('deleteButton').disabled = true;
            isEditing = false;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14">조회된 데이터가 없습니다.</td></tr>';
                return;
            }

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.dataset.id = item.id;
                
                tr.innerHTML = `
                    <td><input type="radio" name="selectRow" value="${item.id}" onchange="handleRowSelection(this)"></td>
                    <td>${item.id}</td>
                    <td data-col="region">${item.region}</td>
                    <td data-col="worker" title="${item.worker}">${item.worker}</td>
                    <td data-col="w_date">${item.w_date.substring(0, 10)}</td>
                    <td data-col="new_species">${item.new_species}</td>
                    <td data-col="new_bookcount">${item.new_bookcount}</td>
                    <td data-col="rearray_species">${item.rearray_species}</td>
                    <td data-col="rearray_bookcount">${item.rearray_bookcount}</td>
                    <td data-col="multipart_species">${item.multipart_species}</td>
                    <td data-col="multipart_bookcount">${item.multipart_bookcount}</td>
                    <td data-col="edit_bookcount">${item.edit_bookcount}</td>
                    <td data-col="authority_bookcount">${item.authority_bookcount}</td>
                    <td data-col="update_user">${item.update_user}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination(totalPages) {
            const container = document.getElementById('paginationContainer');
            container.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.add('page-button');
                if (i === currentPage) {
                    button.classList.add('active');
                }
                button.addEventListener('click', () => fetchData(i));
                container.appendChild(button);
            }
        }

        function handleRowSelection(radio) {
            selectedId = radio.value;
            document.getElementById('editStartButton').disabled = false;
            document.getElementById('deleteButton').disabled = false;
        }

        // --- CRUD Operations ---

        // 6-4) 신규 등록
        document.getElementById('insertButton').addEventListener('click', async () => {
            const data = {
                region: document.getElementById('input_region').value,
                worker: document.getElementById('input_worker').value,
                w_date: document.getElementById('input_w_date').value,
                new_species: document.getElementById('input_new_species').value,
                new_bookcount: document.getElementById('input_new_bookcount').value,
                rearray_species: document.getElementById('input_rearray_species').value,
                rearray_bookcount: document.getElementById('input_rearray_bookcount').value,
                multipart_species: document.getElementById('input_multipart_species').value,
                multipart_bookcount: document.getElementById('input_multipart_bookcount').value,
                edit_bookcount: document.getElementById('input_edit_bookcount').value,
                authority_bookcount: document.getElementById('input_authority_bookcount').value,
                update_user: USER_ACCOUNT // 6-2) login계정 사용
            };

            try {
                const response = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('등록 중 서버 오류가 발생했습니다.');

                const result = await response.json();
                showMessage('신규 카탈로깅 기록이 성공적으로 등록되었습니다. (ID: ' + result.data.id + ')');
                fetchData(1); // 6-4) 표 refresh
            } catch (error) {
                console.error('Insert error:', error);
                showMessage('등록 실패: ' + error.message, 'error');
            }
        });

        // 7-2) 삭제 작업
        document.getElementById('deleteButton').addEventListener('click', async () => {
            if (!selectedId) {
                showMessage('삭제할 항목을 먼저 선택해주세요.', 'error');
                return;
            }

            if (!confirm('정말로 ID ' + selectedId + ' 항목을 삭제하시겠습니까?')) {
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/${selectedId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('삭제 중 서버 오류가 발생했습니다.');

                showMessage('ID ' + selectedId + ' 항목이 성공적으로 삭제되었습니다.');
                fetchData(currentPage); // 표 refresh
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('삭제 실패: ' + error.message, 'error');
            }
        });

        // 7-1) 수정 작업 시작
        document.getElementById('editStartButton').addEventListener('click', (e) => {
            if (!selectedId) {
                showMessage('수정할 항목을 먼저 선택해주세요.', 'error');
                return;
            }
            if (isEditing) return; // 이미 수정 중이면 무시

            isEditing = true;
            e.target.textContent = '수정 완료';
            e.target.id = 'editCompleteButton';
            e.target.className = 'complete-buttons';
            document.getElementById('deleteButton').disabled = true;

            const row = document.querySelector(`tr[data-id="${selectedId}"]`);
            const colsToEdit = ['region', 'worker', 'w_date', 'new_species', 'new_bookcount', 'rearray_species', 'rearray_bookcount', 'multipart_species', 'multipart_bookcount', 'edit_bookcount', 'authority_bookcount'];
            
            colsToEdit.forEach(col => {
                const cell = row.querySelector(`td[data-col="${col}"]`);
                const originalValue = cell.textContent;
                
                let inputElement;
                if (col === 'region') {
                    inputElement = `<select id="edit_${col}"><option value="국내">국내</option><option value="국외">국외</option></select>`;
                } else if (col === 'w_date') {
                    inputElement = `<input type="date" id="edit_${col}" value="${originalValue.substring(0, 10)}" style="width: 100%;">`;
                } else {
                    inputElement = `<input type="text" id="edit_${col}" value="${originalValue}" style="width: 100%;">`;
                }
                
                cell.dataset.original = originalValue;
                cell.innerHTML = inputElement;
                if (col === 'region') {
                    document.getElementById(`edit_${col}`).value = originalValue;
                }
            });

            // Re-attach the event listener to the new '수정 완료' button
            document.getElementById('editCompleteButton').addEventListener('click', handleEditComplete, { once: true });
        });

        // 7-1) 수정 작업 완료
        async function handleEditComplete() {
            const row = document.querySelector(`tr[data-id="${selectedId}"]`);
            const colsToEdit = ['region', 'worker', 'w_date', 'new_species', 'new_bookcount', 'rearray_species', 'rearray_bookcount', 'multipart_species', 'multipart_bookcount', 'edit_bookcount', 'authority_bookcount'];
            
            const updatedData = {
                id: selectedId,
                update_user: USER_ACCOUNT // 7-1) login계정 사용
            };

            // Collect updated data
            colsToEdit.forEach(col => {
                const inputElement = document.getElementById(`edit_${col}`);
                if (inputElement) {
                    updatedData[col] = inputElement.value;
                }
            });
            
            try {
                const response = await fetch(`${BASE_URL}/${selectedId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });

                if (!response.ok) throw new Error('수정 중 서버 오류가 발생했습니다.');

                showMessage('ID ' + selectedId + ' 항목이 성공적으로 수정되었습니다.');
                fetchData(currentPage); // 표 refresh

            } catch (error) {
                console.error('Update error:', error);
                showMessage('수정 실패: ' + error.message, 'error');
                fetchData(currentPage); // 오류 시 원래 상태로 복구
            } finally {
                // Restore button state
                const completeButton = document.getElementById('editCompleteButton');
                completeButton.textContent = '수정';
                completeButton.id = 'editStartButton';
                completeButton.className = 'edit-buttons';
                document.getElementById('deleteButton').disabled = false;
                isEditing = false;
            }
        }

        // Initial Data Load (7. today - 3 day data)
        fetchData(1);
    </script>
</body>
</html>


